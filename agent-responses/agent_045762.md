---
Task: Investigate reward persistence in combat system
Started: 2025-10-24T06:41:06.356Z
Status: done
Ended: 2025-10-24T06:47:12.278Z
Depth: 0
ParentAgent: root
Prompt: .agent-prompts/agent_045762.txt
PID: 51096
---

I'll investigate the combat reward system to understand the persistence issues. Let me start by examining the key files.[UPDATE] CombatService.ts has two separate reward persistence flows: one in `completeCombatInternal()` (lines 668-711) using repository methods, and another in `applyRewardsTransaction()` (lines 936-1025) using different methods. This is the issue—rewards are being persisted twice with different approaches.[UPDATE] Found the second persistence issue: `completeCombatInternal()` calls `materialRepository.createStack()` and `itemRepository.create()` directly (lines 670, 693), but `applyRewardsTransaction()` calls different methods: `incrementStack()` and `create()` again with different parameters.Now let me check the LocationRepository to understand the LootDrop type and the compilation errors mentioned:[UPDATE] Found 3 compilation errors: 1) `LootDrop` type missing `material_name` and `item_type_name` properties in LocationRepository.ts (lines 322, 325); 2) Test expects `.rewards` property on `CombatRewards` but interface doesn't have it—tests are looking for wrong structure.Now let me find where LootDrop is defined:Let me search more carefully:Perfect. Now I have a comprehensive understanding. Let me create the analysis document:Perfect. Here's the comprehensive analysis of the combat reward persistence issue:

## Investigation Complete

**[UPDATE] Investigation document written to `/Users/silasrhyneer/Code/new-mystica/COMBAT_REWARD_INVESTIGATION.md`**

### Key Findings:

**CRITICAL: Duplicate & Conflicting Reward Persistence**
- **completeCombatInternal()** (lines 668-711) attempts to persist materials/items first using `createStack()` which fails on duplicates
- **applyRewardsTransaction()** (lines 936-1025) attempts persistence again using `incrementStack()` 
- Both are called sequentially from executeAttack/executeDefense (lines 444-451, 583-591)
- If the first fails, errors are silently caught, then second attempt happens but may also fail

**3 Compilation Errors Preventing Testing:**

1. **LocationRepository.ts:322,325** - Code assigns `material_name` and `item_type_name` to LootDrop objects, but those properties don't exist in the interface (only `material_id` and `item_type_id` exist)

2. **LootDrop Interface Gap** - Missing `material_name` and `item_type_name` properties that LocationRepository code expects

3. **Test Structure Mismatch** - Tests expect `result.rewards.currencies.gold` but CombatRewards interface has `currencies` at the top level (`result.currencies.gold`). All 8 reward assertions in the test file are wrong.

**Session Cleanup Timing Bug:**
- Session is deleted AFTER attempting reward persistence (line 1012), even if persistence fails
- Makes transaction non-atomic and prevents retry

**Root Cause:** Two completely independent reward persistence flows that were never reconciled. The code has been refactored multiple times leaving both paths active, with different upsert strategies (createStack vs incrementStack).

**Assistant:** [exited]
