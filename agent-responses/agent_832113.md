---
Task: Fix Inventory Service spec
Instructions: **Problem**: The Inventory Service specification (docs/plans/service-specs/inventory-service-spec.md) has implementation guidance that is too vague. It shows complex logic but doesn't specify WHERE methods live.

**Specific Issues**:
1. The spec shows `calculateItemStats()` being called but doesn't specify if this is:
   - A method in InventoryService?
   - A method in ItemRepository?
   - A utility function?
   - A separate StatsCalculationService?

2. The spec shows `calculateBaseStats()` but same question - where does it live?

3. Missing error handling for stack computation failures

**Your Task**:
1. Read the existing InventoryService implementation: mystica-express/src/services/InventoryService.ts
2. Read the ItemService implementation: mystica-express/src/services/ItemService.ts  
3. Determine where stat calculation ACTUALLY lives or SHOULD live based on existing patterns
4. Update docs/plans/service-specs/inventory-service-spec.md to:
   - Specify the exact service/repository/utility where each method lives
   - Add proper error handling sections
   - Make it clear enough that a developer could implement this without guessing

**Context Files**:
- docs/plans/service-specs/inventory-service-spec.md (the spec to fix)
- mystica-express/src/services/InventoryService.ts (actual implementation)
- mystica-express/src/services/ItemService.ts (related service)
- mystica-express/src/repositories/ItemRepository.ts (data layer)

Return a summary of changes made to the spec.

Give me short, information-dense updates as you finish parts of the task (1-2 sentences, max. Incomplete sentences are fine). Only give these updates if you have important information to share. Prepend updates with: [UPDATE]
Started: 2025-10-21T20:39:34.117Z
Status: done
Ended: 2025-10-21T20:46:16.257Z
Depth: 0
ParentAgent: root
---

I'll help you clarify the Inventory Service specification by examining the existing implementation patterns and updating the spec with precise method locations and error handling.[UPDATE] Found that stats calculations live in StatsService, not within InventoryService or ItemService.[UPDATE] Analyzed existing patterns - StatsService has the methods, but spec needs to clarify WHERE each calculation lives and add error handling.[UPDATE] Updated inventory service spec with precise method locations, error handling, and dependencies. StatsService methods clearly documented.

## Summary of Changes Made

I've updated the `docs/plans/service-specs/inventory-service-spec.md` to address all the vagueness issues:

### 1. **Clarified Method Locations**
- **Stats Calculations**: Explicitly specified that `calculateItemStats()` and `calculateBaseStats()` are handled via `StatsService` methods:
  - `statsService.computeItemStats()` for items with materials
  - `statsService.computeItemStatsForLevel()` for stackable base items
- **Service Dependencies**: Clearly documented that InventoryService depends on `ItemRepository`, `MaterialRepository`, and imports `statsService` singleton

### 2. **Added Comprehensive Error Handling**
- **Stat Calculation Failures**: Added try-catch blocks around all stat calculations with specific `DatabaseError` throws
- **Controller-Level Handling**: Added complete error handling pattern showing proper HTTP status codes and error response format
- **Validation Errors**: Added handling for invalid userId format via `ValidationError`
- **Graceful Degradation**: Specified fallback behavior for missing base stats

### 3. **Made Implementation Precise**
- **Import Statements**: Added exact import paths for StatsService
- **Method Signatures**: Referenced actual method signatures from existing StatsService
- **Data Transformation**: Clarified that material style handling uses `style_id !== 'normal'` pattern (matching existing codebase)
- **Repository Usage**: Specified exact repository methods used (matching existing ItemRepository)

### 4. **Enhanced Dependencies Section**
- **Required Services**: Updated to include all actual dependencies with their purposes
- **Service Architecture**: Clarified constructor injection vs singleton import patterns

The spec now provides crystal-clear guidance for implementation without any ambiguity about where methods should live or how errors should be handled. A developer can now implement this service following established patterns in the codebase.

**Assistant:** [exited]
