---
Task: Fix ImageGenerationService.test.ts timeouts
Instructions: Fix the failing ImageGenerationService test file: tests/unit/services/ImageGenerationService.test.ts

**Current Status:** Environment validation tests passing, 5 tests failing due to timeouts/mock issues

**Issues Identified:**
- Retry logic causing timeouts (2s + 4s delays)
- External service mock configuration incomplete
- Tests not properly isolated

**Your Task:**
1. Read the test file: tests/unit/services/ImageGenerationService.test.ts
2. Read the implementation: src/services/ImageGenerationService.ts
3. Run the test to see current failures: `pnpm test ImageGenerationService.test.ts`
4. Look at ImageGenerationService.minimal.test.ts which has 26 passing tests for good patterns
5. Determine what's wrong:
   - Mock setTimeout to avoid retry delays
   - Ensure Replicate API mocks are properly configured
   - Fix mock isolation between tests

**What to Do:**
- Mock setTimeout or disable retry delays in tests
- Complete external service mock configurations
- Ensure proper mock reset between tests

Run the tests after your fixes and report:
- What was wrong
- What you fixed
- Final test results

Give me short, information-dense updates as you finish parts of the task (1-2 sentences, max. Incomplete sentences are fine). Only give these updates if you have important information to share. Prepend updates with: [UPDATE]
Started: 2025-10-22T03:21:28.611Z
Status: done
Ended: 2025-10-22T03:32:51.235Z
Depth: 0
ParentAgent: root
---

I'll help you fix the failing ImageGenerationService test. Let me start by examining the current test file and implementation to understand the issues.Now let me read the implementation to understand the structure:Now let me look at the minimal test file to understand good patterns:Now let me run the failing test to see what the current issues are:[UPDATE] Tests timing out due to retry logic delays. Need to analyze and fix mock setup.

Let me run the specific test file with a shorter timeout and check for any errors:The timeout issue seems to be related to the retry logic. Let me examine the setTimeout mock more carefully and fix the issues. The key problems are:

1. The setTimeout mock isn't properly working for the retry delays
2. Mock isolation between tests isn't complete
3. External service mocks need better configuration

Let me create a fixed version of the test file:I can see the issue. The setTimeout mock implementation is flawed - it's calling the function immediately but that breaks the retry logic flow. Let me fix the test file by implementing a proper mock that doesn't cause timeouts:

**Assistant:** [exited]
